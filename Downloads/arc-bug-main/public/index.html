<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arc Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Libre+Baskerville:ital@0;1&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0a0a0c;
      --bg-surface: #12121a;
      --bg-elevated: #1a1a24;
      --bg-hover: #22222e;
      --border: #2a2a3a;
      --text-primary: #e8e6e3;
      --text-secondary: #8a8a9a;
      --text-muted: #5a5a6a;
      --accent-open: #ff6b6b;
      --accent-progress: #ffd93d;
      --accent-fixed: #6bcb77;
      --accent-link: #74b9ff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Subtle grid pattern background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-family: 'Libre Baskerville', serif;
      font-size: 2.5rem;
      font-weight: 400;
      margin-bottom: 0.5rem;
      letter-spacing: -0.02em;
    }

    h1 span {
      color: var(--text-muted);
      font-style: italic;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    /* Stats cards */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      text-align: center;
      transition: transform 0.2s, border-color 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      border-color: var(--text-muted);
    }

    .stat-card.active {
      border-color: var(--accent-link);
      background: var(--bg-elevated);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 600;
      display: block;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .stat-card.open .stat-number { color: var(--accent-open); }
    .stat-card.fixed .stat-number { color: var(--accent-fixed); }

    /* Filter bar */
    .filters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: var(--text-muted);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: var(--bg-elevated);
      border-color: var(--accent-link);
      color: var(--text-primary);
    }

    /* Bug list */
    .bug-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .bug-card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      padding-bottom: 3.5rem; /* Extra space for bottom-right button */
      transition: border-color 0.2s;
      position: relative;
    }

    .bug-card:hover {
      border-color: var(--text-muted);
    }

    .bug-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .bug-id {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .bug-involved {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      margin-left: 0.75rem;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .involved-name {
      color: var(--text-secondary);
    }

    .involved-name:not(:last-child)::after {
      content: ', ';
    }

    .involved-more {
      color: var(--text-muted);
      margin-left: 0.25rem;
    }

    .bug-status {
      font-size: 0.7rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 500;
      white-space: nowrap;
    }

    .bug-status.open {
      background: rgba(255, 107, 107, 0.15);
      color: var(--accent-open);
      border: 1px solid rgba(255, 107, 107, 0.3);
    }

    .bug-status.fixed {
      background: rgba(107, 203, 119, 0.15);
      color: var(--accent-fixed);
      border: 1px solid rgba(107, 203, 119, 0.3);
    }

    .bug-content {
      font-size: 0.9rem;
      margin-bottom: 1rem;
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .bug-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .bug-meta a {
      color: var(--accent-link);
      text-decoration: none;
    }

    .bug-meta a:hover {
      text-decoration: underline;
    }

    .bug-channel {
      background: var(--bg-elevated);
      padding: 0.15rem 0.5rem;
      border-radius: 3px;
    }

    /* Status badge - clickable when has updates */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .status-badge:hover {
      filter: brightness(1.1);
    }

    .status-badge.fixed {
      background: rgba(107, 203, 119, 0.12);
      border: 1px solid rgba(107, 203, 119, 0.25);
      color: var(--accent-fixed);
    }

    .status-badge .badge-icon {
      font-size: 0.9rem;
    }

    .status-badge .badge-user {
      font-weight: 600;
    }

    .status-badge .badge-expand {
      font-size: 0.65rem;
      opacity: 0.7;
      margin-left: 0.25rem;
      transition: transform 0.2s;
    }

    .status-badge.expanded .badge-expand {
      transform: rotate(180deg);
    }

    /* Thread view - Discord-style */
    .thread-view {
      display: none;
      margin-top: 0.75rem;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .thread-view.open {
      display: block;
      animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .thread-header {
      padding: 0.6rem 1rem;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .thread-header-icon {
      opacity: 0.6;
    }

    .thread-messages {
      max-height: 300px;
      overflow-y: auto;
    }

    .thread-message {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
    }

    .thread-message:last-child {
      border-bottom: none;
    }

    .thread-message-content {
      flex: 1;
      min-width: 0;
    }

    .thread-message-header {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .thread-author {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-primary);
    }

    .thread-time {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .thread-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .thread-message.status-change .thread-text {
      padding: 0.4rem 0.6rem;
      background: var(--bg-elevated);
      border-radius: 4px;
      border-left: 3px solid var(--accent-fixed);
    }

    /* Discord link in thread */
    .thread-discord-link {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.7rem;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .thread-discord-link:hover {
      opacity: 1;
      color: var(--accent-link);
    }

    /* Reactions - Discord style */
    .reactions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }

    .reaction {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: default;
      position: relative;
    }

    .reaction:hover {
      border-color: var(--text-muted);
    }

    .reaction-emoji {
      font-size: 0.9rem;
    }

    .reaction-count {
      color: var(--text-secondary);
      font-size: 0.75rem;
      font-weight: 500;
    }

    /* Reaction tooltip */
    .reaction-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      min-width: 80px;
      text-align: center;
    }

    .reaction-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--border);
    }

    .reaction:hover .reaction-tooltip {
      opacity: 1;
      visibility: visible;
    }

    .reaction-tooltip-title {
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 0.35rem;
      font-size: 1.1rem;
    }

    .reaction-tooltip-users {
      color: var(--text-secondary);
      font-size: 0.75rem;
      line-height: 1.4;
    }

    /* Bug card reactions */
    .bug-reactions {
      margin-top: 0.75rem;
    }

    /* Add Context Button - positioned at bottom right of card */
    .add-context-btn {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      z-index: 10;
    }

    .add-context-btn:hover {
      border-color: var(--accent-link);
      color: var(--text-primary);
    }

    .add-context-btn .btn-icon {
      font-size: 0.85rem;
    }

    /* View Context Badge - next to status/replies badge */
    .view-context-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      margin-left: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .view-context-badge:hover {
      filter: brightness(1.1);
      border-color: var(--accent-link);
    }

    .view-context-badge .badge-icon {
      font-size: 0.9rem;
    }

    .view-context-badge .badge-expand {
      font-size: 0.65rem;
      opacity: 0.7;
      margin-left: 0.25rem;
      transition: transform 0.2s;
    }

    .view-context-badge.expanded .badge-expand {
      transform: rotate(180deg);
    }

    /* Add Context Form - Fixed overlay modal */
    .context-form-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .context-form-overlay.open {
      display: flex;
    }

    .context-form {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .context-form-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .context-form-group {
      margin-bottom: 1rem;
    }

    .context-form-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .context-form-select,
    .context-form-input,
    .context-form-textarea {
      width: 100%;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.6rem 0.75rem;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.85rem;
      transition: border-color 0.2s;
    }

    .context-form-select {
      background: var(--bg-deep);
    }

    .context-form-select:focus,
    .context-form-input:focus,
    .context-form-textarea:focus {
      outline: none;
      border-color: var(--accent-link);
    }

    .context-form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .context-form-file {
      width: 100%;
      background: var(--bg-deep);
      border: 1px dashed var(--border);
      color: var(--text-secondary);
      padding: 1rem;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.85rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .context-form-file:hover {
      border-color: var(--accent-link);
    }

    .file-preview {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .context-form-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .context-form-btn {
      flex: 1;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .context-form-btn.primary {
      background: linear-gradient(135deg, var(--accent-link) 0%, #5b9ff5 100%);
      color: white;
    }

    .context-form-btn.primary:hover {
      filter: brightness(1.1);
    }

    .context-form-btn.secondary {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .context-form-btn.secondary:hover {
      border-color: var(--text-muted);
      color: var(--text-primary);
    }

    .context-form-error {
      color: var(--accent-open);
      font-size: 0.75rem;
      margin-top: 0.5rem;
      display: none;
    }

    .context-form-error.visible {
      display: block;
    }

    .context-form-success {
      color: var(--accent-fixed);
      font-size: 0.75rem;
      margin-top: 0.5rem;
      display: none;
    }

    .context-form-success.visible {
      display: block;
    }

    /* Attachment display in thread */
    .thread-attachment {
      margin-top: 0.5rem;
      padding: 0.75rem;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .thread-attachment.screenshot img {
      max-width: 100%;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .thread-attachment.link {
      border-left: 3px solid var(--accent-link);
    }

    .thread-attachment.conversation {
      border-left: 3px solid var(--accent-progress);
    }

    .thread-attachment-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .thread-attachment-link {
      color: var(--accent-link);
      text-decoration: none;
      word-break: break-all;
    }

    .thread-attachment-link:hover {
      text-decoration: underline;
    }

    .thread-attachment-conversation {
      font-size: 0.8rem;
      color: var(--text-secondary);
      white-space: pre-wrap;
      padding: 0.5rem;
      background: var(--bg-deep);
      border-radius: 4px;
    }

    .thread-attachment-conversation.collapsed {
      max-height: 150px;
      overflow: hidden;
      position: relative;
    }

    .thread-attachment-conversation.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: linear-gradient(transparent, var(--bg-deep));
    }

    .expand-text-btn {
      display: inline-block;
      margin-top: 0.5rem;
      padding: 0.25rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.7rem;
      color: var(--accent-link);
      cursor: pointer;
      transition: all 0.2s;
    }

    .expand-text-btn:hover {
      border-color: var(--accent-link);
    }

    /* Context View - separate from thread view */
    .context-view {
      display: none;
      margin-top: 0.75rem;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .context-view.open {
      display: block;
      animation: slideDown 0.2s ease-out;
    }

    .context-header {
      padding: 0.6rem 1rem;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .context-header-icon {
      opacity: 0.6;
    }

    .context-items {
      max-height: 400px;
      overflow-y: auto;
    }

    .context-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
    }

    .context-item:last-child {
      border-bottom: none;
    }

    .context-empty {
      padding: 2rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading::after {
      content: '...';
      animation: pulse 1.5s infinite;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container {
        padding: 1rem;
      }
      
      h1 {
        font-size: 1.75rem;
      }

      .bug-header {
        flex-direction: column;
        gap: 0.5rem;
      }

      .search-sidebar {
        width: 100%;
        transform: translateX(100%);
      }

      .main-content.sidebar-open {
        margin-right: 0;
      }

      .search-sidebar.open {
        transform: translateX(0);
      }

      .search-btn {
        right: 1rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
      }

      .admin-link {
        position: static;
        margin-bottom: 1rem;
      }
    }

    /* Admin Button */
    .admin-link {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .admin-link:hover {
      border-color: var(--text-muted);
      color: var(--text-primary);
    }

    .admin-link .lock-icon {
      font-size: 0.9rem;
    }

    /* Modal Styles (login only) */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 2rem;
      width: 90%;
      max-width: 420px;
      transform: translateY(-20px);
      transition: transform 0.2s;
    }

    .modal-overlay.open .modal {
      transform: translateY(0);
    }

    .modal-title {
      font-family: 'Libre Baskerville', serif;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .modal-subtitle {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 1.5rem;
    }

    .modal-input {
      width: 100%;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      transition: border-color 0.2s;
    }

    .modal-input:focus {
      outline: none;
      border-color: #6366f1;
    }

    .modal-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .modal-btn {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .modal-btn.primary {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
    }

    .modal-btn.primary:hover {
      filter: brightness(1.1);
    }

    .modal-btn.secondary {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .modal-btn.secondary:hover {
      border-color: var(--text-muted);
      color: var(--text-primary);
    }

    .modal-error {
      color: var(--accent-open);
      font-size: 0.8rem;
      margin-top: -0.5rem;
      margin-bottom: 1rem;
      display: none;
    }

    .modal-error.visible {
      display: block;
    }

    /* Login Screen */
    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 2rem;
    }

    .login-box {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 2.5rem;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-box h1 {
      font-family: 'Libre Baskerville', serif;
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
    }

    .login-box .login-subtitle {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 2rem;
    }

    .login-input {
      width: 100%;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.875rem 1rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      transition: border-color 0.2s;
    }

    .login-input:focus {
      outline: none;
      border-color: var(--accent-link);
    }

    .login-btn {
      width: 100%;
      background: linear-gradient(135deg, #74b9ff 0%, #6366f1 100%);
      border: none;
      color: white;
      padding: 0.875rem 1rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: filter 0.2s;
    }

    .login-btn:hover {
      filter: brightness(1.1);
    }

    .login-error {
      color: var(--accent-open);
      font-size: 0.8rem;
      margin-top: 1rem;
      display: none;
    }

    .login-error.visible {
      display: block;
    }

    /* Dashboard - hidden until logged in */
    .dashboard {
      display: none;
    }

    .dashboard.visible {
      display: flex;
      gap: 0;
    }

    .main-content {
      flex: 1;
      min-width: 0;
      transition: margin-right 0.3s ease;
    }

    .main-content.sidebar-open {
      margin-right: 400px;
    }

    /* Search Sidebar */
    .search-sidebar {
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      width: 400px;
      background: var(--bg-surface);
      border-left: 1px solid var(--border);
      transform: translateX(400px);
      transition: transform 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .search-sidebar.open {
      transform: translateX(0);
    }

    .search-sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-elevated);
    }

    .search-sidebar-header h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .close-sidebar-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.25rem;
      transition: color 0.2s;
    }

    .close-sidebar-btn:hover {
      color: var(--text-primary);
    }

    .sidebar-search-box {
      width: 100%;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }

    .sidebar-search-box:focus {
      outline: none;
      border-color: var(--accent-link);
    }

    .search-results {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .search-result-item {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .search-result-item:hover {
      border-color: var(--text-muted);
      background: var(--bg-hover);
    }

    .search-result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .search-result-id {
      color: var(--accent-link);
      font-size: 0.85rem;
      font-weight: 600;
    }

    .search-result-type {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .search-result-content {
      font-size: 0.85rem;
      line-height: 1.5;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .search-highlight {
      background: rgba(116, 185, 255, 0.3);
      color: var(--text-primary);
      padding: 0 0.2rem;
      border-radius: 2px;
    }

    .search-result-meta {
      display: flex;
      gap: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .search-empty {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
    }

    .search-empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }

    .search-stats {
      padding: 0.75rem 1rem;
      background: var(--bg-deep);
      border-bottom: 1px solid var(--border);
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .search-btn {
      position: fixed;
      top: 1.5rem;
      right: 7rem;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .search-btn:hover {
      border-color: var(--text-muted);
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>üîê Arc Tracker</h1>
      <p class="login-subtitle">Enter password to view the dashboard</p>
      <input type="password" class="login-input" id="passwordInput" placeholder="Password" onkeypress="if(event.key==='Enter')login()">
      <button class="login-btn" onclick="login()">Access Dashboard</button>
      <p class="login-error" id="loginError">Invalid password</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="main-content" id="mainContent">
      <!-- Admin Link -->
      <a href="#" class="admin-link" id="adminLink" onclick="handleAdminClick(event)">
        <span class="lock-icon">üîí</span>
        <span>Admin</span>
      </a>

      <!-- Search Button -->
      <button class="search-btn" onclick="toggleSearchSidebar()">
        <span>üîç</span>
        <span>Search</span>
      </button>

      <!-- Admin Login Modal -->
      <div class="modal-overlay" id="loginModal">
        <div class="modal">
          <h2 class="modal-title">Admin Access</h2>
          <p class="modal-subtitle">Enter your password to access the admin dashboard</p>
          <input type="password" class="modal-input" id="adminPassword" placeholder="Password" onkeypress="if(event.key==='Enter')submitLogin()">
          <p class="modal-error" id="loginError">Invalid password</p>
          <div class="modal-buttons">
            <button class="modal-btn secondary" onclick="closeLoginModal()">Cancel</button>
            <button class="modal-btn primary" onclick="submitLogin()">Login</button>
          </div>
        </div>
      </div>

      <div class="container">
    <header>
      <h1>Arc <span>tracker</span></h1>
      <p class="subtitle" id="subtitle">Bug reports from Discord</p>
    </header>

    <div class="stats" id="stats">
      <div class="stat-card" data-filter="all">
        <span class="stat-number" id="stat-total">-</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-card open" data-filter="open">
        <span class="stat-number" id="stat-open">-</span>
        <span class="stat-label">Open</span>
      </div>
      <div class="stat-card fixed" data-filter="fixed">
        <span class="stat-number" id="stat-fixed">-</span>
        <span class="stat-label">Done</span>
      </div>
    </div>

    <div class="filters">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="open">Open</button>
      <button class="filter-btn" data-filter="fixed">Done</button>
    </div>

    <div class="bug-list" id="bug-list">
      <div class="loading">Loading bugs</div>
    </div>
  </div>
  </div> <!-- End main-content -->

    <!-- Search Sidebar -->
    <div class="search-sidebar" id="searchSidebar">
      <div class="search-sidebar-header">
        <h2>
          <span>üîç Search</span>
          <button class="close-sidebar-btn" onclick="toggleSearchSidebar()">‚úï</button>
        </h2>
        <input 
          type="text" 
          class="sidebar-search-box" 
          id="sidebarSearchBox" 
          placeholder="Search bugs, replies, and context..." 
          oninput="performSearch()"
        >
      </div>
      <div class="search-stats" id="searchStats" style="display: none;"></div>
      <div class="search-results" id="searchResults">
        <div class="search-empty">
          <div class="search-empty-icon">üîç</div>
          <p>Enter a search term to find bugs,<br>replies, and manually added context</p>
        </div>
      </div>
    </div>
  </div> <!-- End dashboard -->

  <script>
    // =========================================
    // Dashboard Password Authentication
    // =========================================
    let dashboardPassword = sessionStorage.getItem('arcTrackerDashboardPwd') || '';

    // Check if already logged in
    if (dashboardPassword) {
      verifyAndShow();
    }

    async function verifyAndShow() {
      try {
        const res = await fetch('/api/dashboard/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: dashboardPassword })
        });
        if (res.ok) {
          showDashboard();
        } else {
          sessionStorage.removeItem('arcTrackerDashboardPwd');
          dashboardPassword = '';
        }
      } catch (e) {
        console.error('Failed to verify:', e);
      }
    }

    async function login() {
      const password = document.getElementById('passwordInput').value;
      
      try {
        const res = await fetch('/api/dashboard/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        
        if (res.ok) {
          dashboardPassword = password;
          sessionStorage.setItem('arcTrackerDashboardPwd', password);
          showDashboard();
        } else {
          document.getElementById('loginError').classList.add('visible');
        }
      } catch (e) {
        document.getElementById('loginError').textContent = 'Connection error';
        document.getElementById('loginError').classList.add('visible');
      }
    }

    function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').classList.add('visible');
      // Start fetching data once logged in
      setupListeners();
      fetchData();
      // Auto-refresh every 30 seconds
      setInterval(fetchData, 30000);
    }

    // =========================================
    // Dashboard Data & UI
    // =========================================
    let allBugs = [];
    let currentFilter = 'all';
    let searchSidebarOpen = false;
    
    // Track open states to preserve during refresh
    const openStates = {
      threads: new Set(),
      contexts: new Set(),
      forms: new Set()
    };

    // Format relative time
    function timeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);
      
      const intervals = [
        { label: 'y', seconds: 31536000 },
        { label: 'mo', seconds: 2592000 },
        { label: 'd', seconds: 86400 },
        { label: 'h', seconds: 3600 },
        { label: 'm', seconds: 60 },
      ];
      
      for (const interval of intervals) {
        const count = Math.floor(seconds / interval.seconds);
        if (count >= 1) {
          return `${count}${interval.label} ago`;
        }
      }
      return 'just now';
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Find who changed the status based on updates
    function findStatusChanger(bug) {
      const updates = bug.updates || [];
      for (const update of updates) {
        const content = update.content;
        if (bug.status === 'fixed' && (content.includes('‚úÖ') || content.toLowerCase().includes('fixed') || content.toLowerCase().includes('resolved'))) {
          return update.author_name;
        }
      }
      return null;
    }

    // Check if an update is a status-changing update
    function isStatusUpdate(content) {
      return content.includes('‚úÖ') || content.toLowerCase().includes('fixed') || content.toLowerCase().includes('resolved');
    }

    // Toggle thread view
    function toggleThread(bugId) {
      const thread = document.getElementById(`thread-${bugId}`);
      const badge = document.getElementById(`badge-${bugId}`);
      
      if (thread.classList.contains('open')) {
        thread.classList.remove('open');
        badge?.classList.remove('expanded');
        openStates.threads.delete(bugId);
      } else {
        thread.classList.add('open');
        badge?.classList.add('expanded');
        openStates.threads.add(bugId);
      }
    }

    // Toggle context form (modal)
    function toggleContextForm(bugId) {
      const overlay = document.getElementById(`context-form-overlay-${bugId}`);
      
      if (overlay.classList.contains('open')) {
        overlay.classList.remove('open');
        openStates.forms.delete(bugId);
      } else {
        overlay.classList.add('open');
        openStates.forms.add(bugId);
        // Clear any previous messages
        document.getElementById(`context-error-${bugId}`).classList.remove('visible');
        document.getElementById(`context-success-${bugId}`).classList.remove('visible');
        // Reset form
        document.getElementById(`context-type-${bugId}`).value = 'link';
        updateContextFields(bugId);
      }
    }

    // Toggle context view
    function toggleContextView(bugId) {
      const view = document.getElementById(`context-view-${bugId}`);
      const badge = document.getElementById(`context-badge-${bugId}`);
      
      if (view.classList.contains('open')) {
        view.classList.remove('open');
        badge?.classList.remove('expanded');
        openStates.contexts.delete(bugId);
      } else {
        view.classList.add('open');
        badge?.classList.add('expanded');
        openStates.contexts.add(bugId);
      }
    }

    // Toggle text expansion
    function toggleTextExpand(id) {
      const text = document.getElementById(`text-${id}`);
      const btn = document.getElementById(`expand-${id}`);
      
      if (text.classList.contains('collapsed')) {
        text.classList.remove('collapsed');
        btn.textContent = 'Show less';
      } else {
        text.classList.add('collapsed');
        btn.textContent = 'Show more';
      }
    }

    // Handle file selection for screenshot upload
    function handleFileSelect(bugId) {
      const fileInput = document.getElementById(`context-file-${bugId}`);
      const preview = document.getElementById(`file-preview-${bugId}`);
      const file = fileInput.files[0];
      
      if (file) {
        if (!file.type.startsWith('image/')) {
          preview.textContent = 'Please select an image file';
          preview.style.color = 'var(--accent-open)';
          return;
        }
        preview.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
        preview.style.color = 'var(--accent-fixed)';
      } else {
        preview.textContent = '';
      }
    }

    // Update context form fields based on type selection
    function updateContextFields(bugId) {
      const type = document.getElementById(`context-type-${bugId}`).value;
      const urlGroup = document.getElementById(`context-url-group-${bugId}`);
      const fileGroup = document.getElementById(`context-file-group-${bugId}`);
      const contentGroup = document.getElementById(`context-content-group-${bugId}`);
      const contentLabel = document.getElementById(`context-content-label-${bugId}`);
      
      // Hide all
      urlGroup.style.display = 'none';
      fileGroup.style.display = 'none';
      contentGroup.style.display = 'none';
      
      if (type === 'link') {
        urlGroup.style.display = 'block';
      } else if (type === 'screenshot') {
        fileGroup.style.display = 'block';
      } else if (type === 'conversation') {
        contentGroup.style.display = 'block';
        contentLabel.textContent = 'Conversation Export';
      }
    }

    // Submit context form
    async function submitContext(bugId) {
      const type = document.getElementById(`context-type-${bugId}`).value;
      const url = document.getElementById(`context-url-${bugId}`).value;
      const content = document.getElementById(`context-content-${bugId}`).value;
      const fileInput = document.getElementById(`context-file-${bugId}`);
      const username = document.getElementById(`context-username-${bugId}`).value;
      const errorEl = document.getElementById(`context-error-${bugId}`);
      const successEl = document.getElementById(`context-success-${bugId}`);
      
      // Reset messages
      errorEl.classList.remove('visible');
      successEl.classList.remove('visible');
      
      let attachmentUrl = url;
      let attachmentData = content;
      
      // Validate and handle file upload for screenshots
      if (type === 'screenshot') {
        const file = fileInput.files[0];
        if (!file) {
          errorEl.textContent = 'Please select an image file';
          errorEl.classList.add('visible');
          return;
        }
        
        // Convert to base64
        try {
          const base64 = await fileToBase64(file);
          attachmentData = base64;
        } catch (e) {
          errorEl.textContent = 'Failed to read image file';
          errorEl.classList.add('visible');
          return;
        }
      } else if (type === 'link' && !url) {
        errorEl.textContent = 'Please enter a URL';
        errorEl.classList.add('visible');
        return;
      } else if (type === 'conversation' && !content) {
        errorEl.textContent = 'Please paste the conversation';
        errorEl.classList.add('visible');
        return;
      }
      
      try {
        const res = await fetch(`/api/bugs/${bugId}/context`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            type, 
            url: attachmentUrl, 
            content: attachmentData, 
            username: username || 'Anonymous' 
          })
        });
        
        if (res.ok) {
          successEl.textContent = 'Context added successfully!';
          successEl.classList.add('visible');
          // Refresh data and close modal after 1 second
          setTimeout(() => {
            fetchData();
            toggleContextForm(bugId);
          }, 1000);
        } else {
          const data = await res.json();
          errorEl.textContent = data.error || 'Failed to add context';
          errorEl.classList.add('visible');
        }
      } catch (e) {
        errorEl.textContent = 'Connection error';
        errorEl.classList.add('visible');
      }
    }

    // Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Render reactions Discord-style
    function renderReactions(reactions, className = 'reactions') {
      if (typeof reactions === 'string') {
        try {
          reactions = JSON.parse(reactions);
        } catch {
          return '';
        }
      }
      if (!reactions || !Array.isArray(reactions) || reactions.length === 0) return '';
      
      const reactionsHtml = reactions.map(r => {
        let usersText;
        if (r.users && r.users.length > 0) {
          if (r.users.length <= 5) {
            usersText = r.users.join(', ');
          } else {
            usersText = r.users.slice(0, 5).join(', ') + ` and ${r.users.length - 5} more`;
          }
        } else {
          usersText = `${r.count} user${r.count > 1 ? 's' : ''}`;
        }
        
        return `
          <div class="reaction">
            <span class="reaction-emoji">${r.emoji}</span>
            <span class="reaction-count">${r.count}</span>
            <div class="reaction-tooltip">
              <div class="reaction-tooltip-title">${r.emoji}</div>
              <div class="reaction-tooltip-users">${escapeHtml(usersText)}</div>
            </div>
          </div>
        `;
      }).join('');
      
      return `<div class="${className}">${reactionsHtml}</div>`;
    }

    // Render a single bug card
    function renderBug(bug) {
      const updates = bug.updates || [];
      const statusChanger = findStatusChanger(bug);
      
      // Separate Discord replies from manual context
      const discordUpdates = updates.filter(u => !u.attachment_type);
      const contextItems = updates.filter(u => u.attachment_type);
      const hasDiscordUpdates = discordUpdates.length > 0;
      const hasContextItems = contextItems.length > 0;
      
      // Render status badge if fixed
      let statusBadgeHtml = '';
      if (bug.status === 'fixed') {
        const byUser = statusChanger ? `by <span class="badge-user">${escapeHtml(statusChanger)}</span>` : '';
        const expandIcon = hasDiscordUpdates ? '<span class="badge-expand">‚ñº</span>' : '';
        
        statusBadgeHtml = `
          <div class="status-badge fixed" id="badge-${bug.id}" ${hasDiscordUpdates ? `onclick="toggleThread(${bug.id})"` : ''}>
            <span class="badge-icon">‚úì</span>
            <span>Fixed ${byUser}</span>
            ${expandIcon}
          </div>
        `;
      } else if (hasDiscordUpdates) {
        statusBadgeHtml = `
          <div class="status-badge" style="background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-secondary);" id="badge-${bug.id}" onclick="toggleThread(${bug.id})">
            <span class="badge-icon">üí¨</span>
            <span>${discordUpdates.length} response${discordUpdates.length > 1 ? 's' : ''}</span>
            <span class="badge-expand">‚ñº</span>
          </div>
        `;
      }

      // Add context badge if there are context items
      let contextBadgeHtml = '';
      if (hasContextItems) {
        contextBadgeHtml = `
          <div class="view-context-badge" id="context-badge-${bug.id}" onclick="toggleContextView(${bug.id})">
            <span class="badge-icon">üìé</span>
            <span>${contextItems.length} context</span>
            <span class="badge-expand">‚ñº</span>
          </div>
        `;
      }

      // Render thread view (Discord replies only)
      let threadHtml = '';
      if (discordUpdates.length > 0) {
        const messagesHtml = discordUpdates.map(u => {
          const isStatus = isStatusUpdate(u.content);
          const statusClass = isStatus ? 'status-change' : '';
          const discordLink = u.discord_url 
            ? `<a href="${u.discord_url}" target="_blank" rel="noopener" class="thread-discord-link">‚Üí Discord</a>`
            : '';
          const reactionsHtml = renderReactions(u.reactions);
          
          return `
            <div class="thread-message ${statusClass}">
              <div class="thread-message-content">
                <div class="thread-message-header">
                  <span class="thread-author">${escapeHtml(u.author_name)}</span>
                  <span class="thread-time">${timeAgo(u.created_at)}</span>
                  ${discordLink}
                </div>
                <div class="thread-text">${escapeHtml(u.content)}</div>
                ${reactionsHtml}
              </div>
            </div>
          `;
        }).join('');

        threadHtml = `
          <div class="thread-view" id="thread-${bug.id}">
            <div class="thread-header">
              <span class="thread-header-icon">üí¨</span>
              <span>${discordUpdates.length} response${discordUpdates.length > 1 ? 's' : ''}</span>
            </div>
            <div class="thread-messages">
              ${messagesHtml}
            </div>
          </div>
        `;
      }

      // Render context view (manual context only)
      let contextViewHtml = '';
      if (contextItems.length > 0) {
        const contextItemsHtml = contextItems.map((u, idx) => {
          const uniqueId = `${bug.id}-${idx}`;
          let attachmentHtml = '';
          
          if (u.attachment_type === 'link') {
            attachmentHtml = `
              <div class="thread-attachment link">
                <div class="thread-attachment-label">üîó Link</div>
                <a href="${escapeHtml(u.attachment_url || '')}" target="_blank" rel="noopener" class="thread-attachment-link">${escapeHtml(u.attachment_url || '')}</a>
              </div>
            `;
          } else if (u.attachment_type === 'screenshot') {
            attachmentHtml = `
              <div class="thread-attachment screenshot">
                <div class="thread-attachment-label">üì∏ Screenshot</div>
                <img src="${escapeHtml(u.attachment_data || u.attachment_url || '')}" alt="Screenshot" />
              </div>
            `;
          } else if (u.attachment_type === 'conversation') {
            const textContent = u.attachment_data || '';
            const isLong = textContent.length > 500;
            attachmentHtml = `
              <div class="thread-attachment conversation">
                <div class="thread-attachment-label">üí¨ Conversation Export</div>
                <div class="thread-attachment-conversation ${isLong ? 'collapsed' : ''}" id="text-${uniqueId}">${escapeHtml(textContent)}</div>
                ${isLong ? `<button class="expand-text-btn" id="expand-${uniqueId}" onclick="toggleTextExpand('${uniqueId}')">Show more</button>` : ''}
              </div>
            `;
          }
          
          return `
            <div class="context-item">
              <div class="thread-message-header">
                <span class="thread-author">${escapeHtml(u.author_name)}</span>
                <span class="thread-time">${timeAgo(u.created_at)}</span>
              </div>
              ${attachmentHtml}
            </div>
          `;
        }).join('');

        contextViewHtml = `
          <div class="context-view" id="context-view-${bug.id}">
            <div class="context-header">
              <span class="context-header-icon">üìé</span>
              <span>${contextItems.length} context item${contextItems.length > 1 ? 's' : ''}</span>
            </div>
            <div class="context-items">
              ${contextItemsHtml}
            </div>
          </div>
        `;
      }

      // Render bug reactions
      const bugReactionsHtml = renderReactions(bug.reactions, 'reactions bug-reactions');

      // Involved people
      const involved = bug.involved || [bug.author_name];
      const involvedHtml = involved.length > 0 ? `
        <span class="bug-involved">
          ${involved.slice(0, 3).map(name => `<span class="involved-name">${escapeHtml(name)}</span>`).join('')}
          ${involved.length > 3 ? `<span class="involved-more">+${involved.length - 3}</span>` : ''}
        </span>
      ` : '';

      // Add Context Button and Form Modal
      const contextFormHtml = `
        <button class="add-context-btn" id="context-btn-${bug.id}" onclick="toggleContextForm(${bug.id})">
          <span class="btn-icon">üìé</span>
          <span>Add Context</span>
        </button>
        
        <div class="context-form-overlay" id="context-form-overlay-${bug.id}" onclick="if(event.target.id === 'context-form-overlay-${bug.id}') toggleContextForm(${bug.id})">
          <div class="context-form" onclick="event.stopPropagation()">
            <div class="context-form-title">Add Context to Bug #${bug.id}</div>
            
            <div class="context-form-group">
              <label class="context-form-label">Type</label>
              <select class="context-form-select" id="context-type-${bug.id}" onchange="updateContextFields(${bug.id})">
                <option value="link">Link</option>
                <option value="screenshot">Screenshot</option>
                <option value="conversation">Conversation Export</option>
              </select>
            </div>
            
            <div class="context-form-group" id="context-url-group-${bug.id}">
              <label class="context-form-label">URL</label>
              <input type="url" class="context-form-input" id="context-url-${bug.id}" placeholder="https://example.com">
            </div>
            
            <div class="context-form-group" id="context-file-group-${bug.id}" style="display: none;">
              <label class="context-form-label">Upload Image</label>
              <input type="file" class="context-form-file" id="context-file-${bug.id}" accept="image/*" onchange="handleFileSelect(${bug.id})">
              <div class="file-preview" id="file-preview-${bug.id}"></div>
            </div>
            
            <div class="context-form-group" id="context-content-group-${bug.id}" style="display: none;">
              <label class="context-form-label" id="context-content-label-${bug.id}">Content</label>
              <textarea class="context-form-textarea" id="context-content-${bug.id}" placeholder="Paste content here..."></textarea>
            </div>
            
            <div class="context-form-group">
              <label class="context-form-label">Your Name (Optional)</label>
              <input type="text" class="context-form-input" id="context-username-${bug.id}" placeholder="Anonymous">
            </div>
            
            <div class="context-form-buttons">
              <button class="context-form-btn secondary" onclick="toggleContextForm(${bug.id})">Cancel</button>
              <button class="context-form-btn primary" onclick="submitContext(${bug.id})">Submit</button>
            </div>
            
            <div class="context-form-error" id="context-error-${bug.id}"></div>
            <div class="context-form-success" id="context-success-${bug.id}"></div>
          </div>
        </div>
      `;

      return `
        <div class="bug-card" data-id="${bug.id}">
          <div class="bug-header">
            <div>
              <span class="bug-id">#${bug.id}</span>
              ${involvedHtml}
            </div>
            <span class="bug-status ${bug.status}">${bug.status.replace('_', ' ')}</span>
          </div>
          <div class="bug-content">${escapeHtml(bug.content)}</div>
          ${bugReactionsHtml}
          <div class="bug-meta">
            <span>by <strong>${escapeHtml(bug.author_name)}</strong></span>
            <span class="bug-channel">#${escapeHtml(bug.channel_name)}</span>
            <span>${timeAgo(bug.created_at)}</span>
            <a href="${bug.discord_url}" target="_blank" rel="noopener">‚Üí Discord</a>
          </div>
          ${statusBadgeHtml}${contextBadgeHtml}
          ${threadHtml}
          ${contextViewHtml}
          ${contextFormHtml}
        </div>
      `;
    }

    // Render bug list
    function renderBugList(bugs) {
      const container = document.getElementById('bug-list');
      
      if (bugs.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üêõ</div>
            <p>No bugs found${currentFilter !== 'all' ? ' with this filter' : ''}</p>
          </div>
        `;
        return;
      }

      container.innerHTML = bugs.map(renderBug).join('');
      
      // Restore open states after re-render
      restoreOpenStates();
    }

    // Restore open states after re-render
    function restoreOpenStates() {
      // Restore open threads
      openStates.threads.forEach(bugId => {
        const thread = document.getElementById(`thread-${bugId}`);
        const badge = document.getElementById(`badge-${bugId}`);
        if (thread) {
          thread.classList.add('open');
          badge?.classList.add('expanded');
        }
      });
      
      // Restore open context views
      openStates.contexts.forEach(bugId => {
        const view = document.getElementById(`context-view-${bugId}`);
        const badge = document.getElementById(`context-badge-${bugId}`);
        if (view) {
          view.classList.add('open');
          badge?.classList.add('expanded');
        }
      });
      
      // Restore open forms
      openStates.forms.forEach(bugId => {
        const overlay = document.getElementById(`context-form-overlay-${bugId}`);
        if (overlay) {
          overlay.classList.add('open');
        }
      });
    }

    // Update stats
    function updateStats(stats) {
      document.getElementById('stat-total').textContent = stats.total;
      document.getElementById('stat-open').textContent = stats.open;
      document.getElementById('stat-fixed').textContent = stats.fixed;
    }

    // Filter bugs
    function filterBugs() {
      let filtered = allBugs;
      
      if (currentFilter !== 'all') {
        filtered = filtered.filter(b => b.status === currentFilter);
      }
      
      renderBugList(filtered);
    }

    // Update subtitle with monitored channel names (from /api/channels)
    function updateSubtitle(channelNames) {
      const subtitle = document.getElementById('subtitle');
      
      if (channelNames.length === 0) {
        subtitle.textContent = 'Bug reports from Discord';
      } else if (channelNames.length === 1) {
        subtitle.textContent = `Bug reports from #${channelNames[0]}`;
      } else {
        const formatted = channelNames.map(n => `#${n}`).join(' & ');
        subtitle.textContent = `Bug reports from ${formatted}`;
      }
    }

    // Fetch data
    async function fetchData() {
      try {
        const headers = {};
        if (dashboardPassword) {
          headers['X-Dashboard-Password'] = dashboardPassword;
        }

        const [bugsRes, statsRes, channelsRes] = await Promise.all([
          fetch('/api/bugs', { headers }),
          fetch('/api/stats', { headers }),
          fetch('/api/channels', { headers })
        ]);
        
        allBugs = await bugsRes.json();
        const stats = await statsRes.json();
        const channels = await channelsRes.json();
        
        // Extract channel names from monitored channels (not from bugs)
        const channelNames = channels.map(c => c.channel_name).filter(Boolean);
        
        updateStats(stats);
        updateSubtitle(channelNames);
        filterBugs();
      } catch (error) {
        console.error('Failed to fetch data:', error);
        document.getElementById('bug-list').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <p>Failed to load bugs</p>
          </div>
        `;
      }
    }

    // Setup event listeners
    function setupListeners() {
      // Filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          filterBugs();
        });
      });

      // Stat cards as clickable filters
      document.querySelectorAll('.stat-card').forEach(card => {
        card.style.cursor = 'pointer';
        card.addEventListener('click', () => {
          const filter = card.dataset.filter;
          currentFilter = filter;
          
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          const matchingBtn = document.querySelector(`.filter-btn[data-filter="${filter}"]`);
          matchingBtn?.classList.add('active');
          
          document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');
          
          filterBugs();
        });
      });
    }

    // =========================================
    // Admin Login (redirects to /admin)
    // =========================================
    
    // Check if already logged in - if so, go directly to admin
    const storedPassword = sessionStorage.getItem('arcTrackerAdminPwd');

    function handleAdminClick(event) {
      event.preventDefault();
      
      // If we have a stored password, verify and redirect
      if (storedPassword) {
        verifyAndRedirect(storedPassword);
      } else {
        openLoginModal();
      }
    }

    async function verifyAndRedirect(password) {
      try {
        const res = await fetch('/api/admin/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        if (res.ok) {
          window.location.href = '/admin';
        } else {
          // Clear invalid stored password and show login
          sessionStorage.removeItem('arcTrackerAdminPwd');
          openLoginModal();
        }
      } catch (e) {
        console.error('Failed to verify:', e);
        openLoginModal();
      }
    }

    function openLoginModal() {
      document.getElementById('loginModal').classList.add('open');
      document.getElementById('adminPassword').value = '';
      document.getElementById('loginError').classList.remove('visible');
      setTimeout(() => document.getElementById('adminPassword').focus(), 100);
    }

    function closeLoginModal() {
      document.getElementById('loginModal').classList.remove('open');
    }

    async function submitLogin() {
      const password = document.getElementById('adminPassword').value;
      
      try {
        const res = await fetch('/api/admin/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        
        if (res.ok) {
          // Store password and redirect to admin
          sessionStorage.setItem('arcTrackerAdminPwd', password);
          window.location.href = '/admin';
        } else {
          document.getElementById('loginError').classList.add('visible');
        }
      } catch (e) {
        console.error('Login failed:', e);
        document.getElementById('loginError').textContent = 'Connection error';
        document.getElementById('loginError').classList.add('visible');
      }
    }

    // =========================================
    // Search Sidebar Functions
    // =========================================
    function toggleSearchSidebar() {
      searchSidebarOpen = !searchSidebarOpen;
      const sidebar = document.getElementById('searchSidebar');
      const mainContent = document.getElementById('mainContent');
      
      if (searchSidebarOpen) {
        sidebar.classList.add('open');
        mainContent.classList.add('sidebar-open');
        document.getElementById('sidebarSearchBox').focus();
      } else {
        sidebar.classList.remove('open');
        mainContent.classList.remove('sidebar-open');
      }
    }

    function highlightText(text, query) {
      if (!query) return escapeHtml(text);
      const escapedText = escapeHtml(text);
      const regex = new RegExp(`(${escapeHtml(query).replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return escapedText.replace(regex, '<span class="search-highlight">$1</span>');
    }

    function performSearch() {
      const query = document.getElementById('sidebarSearchBox').value.trim().toLowerCase();
      const resultsContainer = document.getElementById('searchResults');
      const statsContainer = document.getElementById('searchStats');
      
      if (!query) {
        resultsContainer.innerHTML = `
          <div class="search-empty">
            <div class="search-empty-icon">üîç</div>
            <p>Enter a search term to find bugs,<br>replies, and manually added context</p>
          </div>
        `;
        statsContainer.style.display = 'none';
        return;
      }

      // Search through all bugs and their updates
      const results = [];
      
      for (const bug of allBugs) {
        const bugMatches = [];
        
        // Search in main bug content
        if (bug.content.toLowerCase().includes(query)) {
          bugMatches.push({
            type: 'Bug Description',
            content: bug.content,
            author: bug.author_name,
            timestamp: bug.created_at
          });
        }
        
        // Search in updates (replies and manual context)
        if (bug.updates && bug.updates.length > 0) {
          for (const update of bug.updates) {
            let matched = false;
            let matchedContent = '';
            
            // Check update content
            if (update.content && update.content.toLowerCase().includes(query)) {
              matched = true;
              matchedContent = update.content;
            }
            
            // Check attachment data (for conversations and screenshots)
            if (update.attachment_data && update.attachment_data.toLowerCase().includes(query)) {
              matched = true;
              matchedContent = update.attachment_data;
            }
            
            // Check attachment URL
            if (update.attachment_url && update.attachment_url.toLowerCase().includes(query)) {
              matched = true;
              matchedContent = update.attachment_url;
            }
            
            if (matched) {
              let type = 'Reply';
              if (update.attachment_type === 'screenshot') type = 'Screenshot';
              else if (update.attachment_type === 'link') type = 'Link';
              else if (update.attachment_type === 'conversation') type = 'Conversation';
              
              bugMatches.push({
                type,
                content: matchedContent,
                author: update.author_name,
                timestamp: update.created_at
              });
            }
          }
        }
        
        if (bugMatches.length > 0) {
          results.push({
            bug,
            matches: bugMatches
          });
        }
      }
      
      // Display results
      if (results.length === 0) {
        resultsContainer.innerHTML = `
          <div class="search-empty">
            <div class="search-empty-icon">üîç</div>
            <p>No results found for "<strong>${escapeHtml(query)}</strong>"</p>
          </div>
        `;
        statsContainer.style.display = 'none';
      } else {
        const totalMatches = results.reduce((sum, r) => sum + r.matches.length, 0);
        statsContainer.style.display = 'block';
        statsContainer.textContent = `Found ${totalMatches} match${totalMatches !== 1 ? 'es' : ''} in ${results.length} bug${results.length !== 1 ? 's' : ''}`;
        
        resultsContainer.innerHTML = results.map(result => {
          const bug = result.bug;
          return result.matches.map(match => `
            <div class="search-result-item" onclick="scrollToBug(${bug.id})">
              <div class="search-result-header">
                <span class="search-result-id">#${bug.id}</span>
                <span class="search-result-type">${match.type}</span>
              </div>
              <div class="search-result-content">
                ${highlightText(match.content.substring(0, 200), query)}${match.content.length > 200 ? '...' : ''}
              </div>
              <div class="search-result-meta">
                <span>üë§ ${escapeHtml(match.author)}</span>
                <span>‚è∞ ${timeAgo(match.timestamp)}</span>
                <span class="bug-status ${bug.status}" style="padding: 0.2rem 0.5rem; font-size: 0.65rem;">${bug.status}</span>
              </div>
            </div>
          `).join('');
        }).join('');
      }
    }

    function scrollToBug(bugId) {
      // Find the bug card
      const cards = document.querySelectorAll('.bug-card');
      for (const card of cards) {
        if (card.dataset.id === bugId.toString()) {
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Highlight animation
          const originalBorder = card.style.borderColor;
          card.style.borderColor = 'var(--accent-link)';
          card.style.boxShadow = '0 0 20px rgba(116, 185, 255, 0.3)';
          
          setTimeout(() => {
            card.style.borderColor = originalBorder;
            card.style.boxShadow = '';
          }, 2000);
          break;
        }
      }
    }

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeLoginModal();
        if (searchSidebarOpen) {
          toggleSearchSidebar();
        }
      }
    });

    // Close modal on overlay click
    document.getElementById('loginModal').addEventListener('click', (e) => {
      if (e.target.id === 'loginModal') {
        closeLoginModal();
      }
    });
  </script>
</body>
</html>
